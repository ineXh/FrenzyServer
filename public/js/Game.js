function Game(){this.teams=[],this.teams.push(new Team(0)),this.teams.push(new Team(1)),this.teams.push(new Team(2)),this.teams.push(new Team(3)),this.init()}function spawnCow(t,a,e){var s={x:t,y:a,type:CharacterType.Cow,team:myteam,color:myteamcolor},i=characters.spawn(s);game.getTeam(myteam).characters[s.type].push(i),e.characters.push({x:s.x/stage_width,y:s.y/stage_height,type:CharacterType.Cow})}function Team(t){this.team=t,this.path=new Path(t),this.color=0==t?Red:1==t?Blue:2==t?Teal:3==t?Purple:Red,this.startlocation=0==t?StartLocation.NW:1==t?StartLocation.NE:2==t?StartLocation.SW:3==t?StartLocation.SE:StartLocation.NW,this.startlocation_pos=getstartlocation(this.startlocation),this.sync_count=0,this.sync_time=50,this.init()}Game.prototype={init:function(){this.collision_count=0,this.collision_time=1,this.updateOpponent_count=0,this.updateOpponent_time=0,this.minimap=new MiniMap},checkcollisions:function(){if(this.collision_count++,!(this.collision_count<this.collision_time)){this.collision_count=0,this.resetcollisioncounts();for(var t=0;t<this.teams.length;t++)for(var a=0;a<this.teams[t].characters.length;a++)for(var e=0;e<this.teams[t].characters[a].length;e++){var s=this.teams[t].characters[a][e];(s.sprite.visible||t==myteam)&&(s.collision_count>=4||this.checkcollision(s))}}},checkcollision:function(t){for(var a=0;a<this.teams.length;a++)for(var e=0;e<this.teams[a].characters.length;e++)for(var s=0;s<this.teams[a].characters[e].length;s++){var i=this.teams[a].characters[e][s];(i.sprite.visible||a==myteam)&&(i.collision_count>=4||t.collide(i))}},resetcollisioncounts:function(){for(var t=0;t<this.teams.length;t++)for(var a=0;a<this.teams[t].characters.length;a++)for(var e=0;e<this.teams[t].characters[a].length;e++)this.teams[t].characters[a][e].collision_count=0},updateOpponent:function(){if(this.updateOpponent_count++,!(this.updateOpponent_count<this.updateOpponent_time)){this.updateOpponent_count=0;for(var t=this.find_closest_opponent.bind(this),a=0;a<this.teams.length;a++)for(var e=0;e<this.teams[a].characters.length;e++)for(var s=0;s<this.teams[a].characters[e].length;s++){var i=this.teams[a].characters[e][s];t(i)}}},find_closest_opponent:function(t){(void 0==t.opponent_dist||null==t.opponent)&&(t.opponent_dist=dim/2);for(var a=dim/2,e=0;e<this.teams.length;e++)if(t.team!=e)for(var s=0;s<this.teams[e].characters.length;s++)for(var i=0;i<this.teams[e].characters[s].length;i++){var o=this.teams[e].characters[s][i];new_dist=findDist(t.pos,o.pos),new_dist<a&&new_dist<t.opponent_dist&&(t.opponent=o,t.opponent_dist=new_dist)}},update:function(){this.checkcollisions(),this.updateOpponent(),this.teams.forEach(function(t){t.update()}),this.minimap.update()},getTeam:function(t){return this.teams[t]},startsingle:function(){gamestate=GameState.InPlay,stage.x=0,stage.y=0,myteam=0,myteamcolor=this.getTeam(myteam.color),this.teams.forEach(function(t){t.startsingle()}),center=this.getTeam(myteam).characters[CharacterType.Cow][0].pos.clone()},startgame:function(){switch(startlocation){case StartLocation.NW:stage.x=0,stage.y=0;break;case StartLocation.NE:stage.x=-stage_width+width,stage.y=0;break;case StartLocation.SW:stage.x=0,stage.y=-stage_height+height;break;case StartLocation.SE:stage.x=-stage_width+width,stage.y=-stage_height+height}for(var t={team:myteam,color:myteamcolor,characters:[]},a=0;5>a;a++)for(var e=0;5>e;e++)spawnCow(-stage.x+width/2+width/20*e,-stage.y+height/2+width/20*a,t);communication.socket.emit("spawn",t),center=this.getTeam(myteam).characters[CharacterType.Cow][0].pos}},Team.prototype={init:function(){this.characters=characters.pool.initList()},clean:function(){},startsingle:function(){for(var t=0;1>t;t++)for(var a=0;1>a;a++){var e={x:this.startlocation_pos.x+width/2+width/20*a,y:this.startlocation_pos.y+height/2+width/20*t,type:CharacterType.Cow,team:this.team,color:this.color},s=characters.spawn(e);this.characters[e.type].push(s)}},update:function(){this.sendSyncCharacter();for(var t=0;t<this.characters.length;t++)if(void 0!=this.characters[t])for(var a=this.characters[t].length-1;a>=0;a--){var e=this.characters[t][a];if(e.update(this.path),e.isDead()){characters.clean(e);var s=this.characters[e.type].indexOf(e);if(s>-1){this.characters[e.type][s];this.characters[e.type].splice(s,1)}}}},sendSyncCharacter:function(){if(gamemode==GameMode.MultiPlayer&&this.team==myteam&&(this.sync_count++,!(this.sync_count<this.sync_time))){this.sync_count=0,this.sync_count=0;for(var t=[],a=0;a<this.characters.length;a++)if(void 0!=this.characters[a]){t[a]=[];for(var e=0;e<this.characters[a].length;e++){var s=this.characters[a][e];t[a].push({x:s.pos.x/stage_width,y:s.pos.y/stage_height,vx:s.vel.x/stage_width,vy:s.vel.y/stage_height,type:s.type})}}communication.socket.emit("sync character",t),this.sendSyncPath()}},sendSyncPath:function(){}};var getstartlocation=function(t){switch(loc=new PVector(0,0),t){case StartLocation.NW:loc.x=0,loc.y=0;break;case StartLocation.NE:loc.x=stage_width-width,loc.y=0;break;case StartLocation.SW:loc.x=0,loc.y=stage_height-height;break;case StartLocation.SE:loc.x=stage_width-width,loc.y=stage_height-height}return loc};