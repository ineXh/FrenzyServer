function Game(){this.teams=[],this.teams.push(new Team(0)),this.teams.push(new Team(1)),this.teams.push(new Team(2)),this.teams.push(new Team(3)),this.players=[],this.init()}function spawnUnitMsg(t,e,a,s){var i={x:t,y:e,type:s,team:myteam,color:myteamcolor};a.characters.push({x:i.x/stage_width,y:i.y/stage_height,type:s})}function Team(t){this.team=t,this.path=new Path(t),this.color=0==t?Red:1==t?Blue:2==t?Teal:3==t?Purple:Red,this.startlocation=0==t?StartLocation.NW:1==t?StartLocation.NE:2==t?StartLocation.SW:3==t?StartLocation.SE:StartLocation.NW,this.startlocation_pos=getstartlocation(this.startlocation),this.sync_count=0,this.sync_time=Client_to_Server_Sync_Period,this.sync_force=!1,this.spawn_count=0,this.spawn_time=SinglePlayer_Spawn_Period,this.spawn_j=0,this.spawn_i=0,this.init(),this.max_unit_count=max_unit_count}function getTeam(t){switch(t){case Team0:return"Team 0";case Team1:return"Team 1";case Team2:return"Team 2";case Team3:return"Team 3";case Observer:return"Observer"}return""}function getTeamColor(t){switch(t){case Team0:return Red;case Team1:return Blue;case Team2:return Teal;case Team3:return Purple;case Observer:return Black}return Black}Game.prototype={init:function(){this.minimap=new MiniMap,this.ui=new GameUI(this),this.collision_count=0,this.collision_time=0,this.updateOpponent_count=0,this.updateOpponent_time=20},clean:function(){this.players.splice(0,this.players.length)},checkcollisions:function(){if(this.collision_count++,!(this.collision_count<this.collision_time)){this.collision_count=0;for(var t=0;t<this.teams.length;t++)for(var e=0;e<this.teams[t].characters.length;e++)for(var a=0;a<this.teams[t].characters[e].length;a++){var s=this.teams[t].characters[e][a];s.override||s.collision_count>=2||this.checkcollision(s)}}},checkcollision:function(t){for(var e=0;e<this.teams.length;e++)for(var a=0;a<this.teams[e].characters.length;a++)for(var s=0;s<this.teams[e].characters[a].length;s++){var i=this.teams[e].characters[a][s];i.override||i.collision_count>=2||t.collide(i)}},resetcollisioncounts:function(){for(var t=0;t<this.teams.length;t++)for(var e=0;e<this.teams[t].characters.length;e++)for(var a=0;a<this.teams[t].characters[e].length;a++)this.teams[t].characters[e][a].collision_count=0},updateOpponent:function(){if(this.updateOpponent_count++,!(this.updateOpponent_count<this.updateOpponent_time)){this.updateOpponent_count=0;for(var t=this.find_closest_opponent.bind(this),e=0;e<this.teams.length;e++)for(var a=0;a<this.teams[e].characters.length;a++)for(var s=0;s<this.teams[e].characters[a].length;s++){var i=this.teams[e].characters[a][s];arrayContains(i.status,StatusType.Inanimate)||t(i)}}},find_closest_opponent:function(t){(void 0==t.opponent_dist||null==t.opponent)&&(t.opponent_dist=dim/2);for(var e=dim/2,a=0;a<this.teams.length;a++)if(t.team!=a)for(var s=0;s<this.teams[a].characters.length;s++)for(var i=0;i<this.teams[a].characters[s].length;i++){var n=this.teams[a].characters[s][i];new_dist=findDist(t.pos,n.pos),new_dist<e&&new_dist<t.opponent_dist&&(t.opponent=n,t.opponent_dist=new_dist)}},update:function(){gamestate==GameState.InPlay&&(gameCount++,this.checkcollisions(),this.updateOpponent(),this.teams.forEach(function(t){t.update()}),this.minimap.update(),this.ui.update())},getTeam:function(t){return this.teams[t]},startsingle:function(){gameCount=0,stagelayout.place_stage(),gamestate=GameState.InPlay,gamemode=GameMode.SinglePlayer,stage.x=0,stage.y=0,myteam=0,myteamcolor=this.getTeam(myteam).color,this.teams.forEach(function(t){t.startsingle()}),this.minimap.init(),this.ui.init()},startgame:function(){stagelayout.place_stage(),gamestate=GameState.InPlay,gamemode=GameMode.MultiPlayer,this.teams.forEach(function(t){t.restartPath()}),myteamcolor=this.getTeam(myteam).color,gamestartCount=0,gameCount=0;var t=getstartlocation(startlocation);stage.x=-t.x,stage.y=-t.y,this.minimap.init(),this.ui.init()},spawnBase:function(t){},onTouchStart:function(){if(gamestate==GameState.InPlay){if(isTouching(MousePos.x,MousePos.y,game.minimap.map))return this.minimap.onTouchStart(),void(this.minimaptouched=!0);pan(),game.getTeam(myteam).path.startPath(MousePos.stage_x,MousePos.stage_y)}},onTouchMove:function(){if(gamestate==GameState.InPlay){if(this.minimaptouched)return void this.minimap.onTouchMove();pan(),game.getTeam(myteam).path.updatePath(MousePos.stage_x,MousePos.stage_y)}},onTouchEnd:function(){if(gamestate==GameState.InPlay){if(this.minimaptouched)return void(this.minimaptouched=!1);this.minimaptouched=!1,game.getTeam(myteam).path.endPath(MousePos.stage_x,MousePos.stage_y),gamemode==GameMode.MultiPlayer&&communication.socket.emit("path",game.getTeam(myteam).path.getLastTwoPoints())}},onTouching:function(){gamestate==GameState.InPlay&&MousePos.touched&&(this.minimaptouched||pan())}},Team.prototype={init:function(){this.characters=characters.pool.initList(),this.reset()},reset:function(){this.coins=0,this.attack_upgrades=0,this.defense_upgrades=0,this.speed_upgrades=0},clean:function(){this.Dead=!1},restartPath:function(){this.path.restart()},startsingle:function(){this.restartPath();var t={x:this.startlocation_pos.x+width/2,y:this.startlocation_pos.y+height/2,type:CharacterType.Hut,team:this.team,color:this.color},e=characters.spawn(t);this.characters[t.type].push(e)},startmultiplayer:function(t){this.restartPath();var e={x:this.startlocation_pos.x+width/2,y:this.startlocation_pos.y+height/2,type:CharacterType.Hut,team:this.team,color:this.color,id:t.base_id},a=characters.spawn(e);this.characters[e.type].push(a)},spawnSinglePlayer:function(){gamemode!=GameMode.MultiPlayer&&(this.characters[CharacterType.Cow].length>=this.max_unit_count||(this.spawn_count++,this.spawn_count<this.spawn_time||(this.spawn_count=0,this.spawn(0))))},spawn:function(t){if(this.characters[CharacterType.Hut].length<=0)return void(this.Dead=!0);if(!(this.characters[CharacterType.Cow].length>=this.max_unit_count)){this.spawn_j>2&&(this.spawn_j=-this.spawn_j),this.spawn_i>2&&(this.spawn_i=-this.spawn_i,this.spawn_j++);var e={x:this.startlocation_pos.x+width/2+this.spawn_i++*big_dim/20,y:this.startlocation_pos.y+height/2+this.spawn_j*big_dim/20,id:t,type:CharacterType.Cow,team:this.team,color:this.color},a=characters.spawn(e);this.characters[e.type].push(a)}},update:function(){for(var t=0;t<this.characters.length;t++)if(void 0!=this.characters[t])for(var e=this.characters[t].length-1;e>=0;e--){var a=this.characters[t][e];a.update(this.path),this.check_dead(a)}this.spawnSinglePlayer(),this.sendPeriodicSync()},check_dead:function(t){if(gamemode!=GameMode.MultiPlayer&&t.isDead()){var e=this.characters[t.type].indexOf(t);if(e>-1){this.characters[t.type][e];gamemode!=GameMode.MultiPlayer?(this.characters[t.type].splice(e,1),characters.clean(t)):this.sendSyncDeadCharacter(t.type,e,t.id)}}},sendPeriodicSync:function(){if(gamemode==GameMode.MultiPlayer&&gamestate==GameState.InPlay&&this.team==myteam&&(this.sync_count++,!(this.sync_count<this.sync_time)||this.sync_force)){this.sync_force&&(this.sync_force=!1),this.sync_count=0,sentPeriodicUpdateGameCount=gameCount;for(var t={gameCount:gameCount,players:[{characters:[]},{characters:[]},{characters:[]},{characters:[]}]},e=0;e<game.teams.length;e++)for(var a=game.teams[e],s=0;s<a.characters.length;s++)if(void 0!=a.characters[s]){t.players[e].characters[s]=[];for(var i=0;i<a.characters[s].length;i++){var n=a.characters[s][i];e==myteam?t.players[e].characters[s].push({x:n.pos.x/stage_width,y:n.pos.y/stage_height,vx:n.vel.x/stage_width,vy:n.vel.y/stage_height,type:n.type,id:n.id}):(t.players[e].characters[s].push({dmg:n.dmg,type:n.type,id:n.id}),n.dmg=0)}}communication.socket.emit("periodic client sync",t),this.sendSyncPath()}},sendForceSync:function(){if(this.sync_force&&gamemode==GameMode.MultiPlayer&&gamestate==GameState.InPlay&&this.team==myteam){this.sync_force=!1,console.log("send Force Sync"),this.sync_count=0;for(var t={gameCount:gameCount,characters:[]},e=0;e<this.characters.length;e++)if(void 0!=this.characters[e]){t.characters[e]=[];for(var a=0;a<this.characters[e].length;a++){var s=this.characters[e][a];t.characters[e].push({x:s.pos.x/stage_width,y:s.pos.y/stage_height,vx:s.vel.x/stage_width,vy:s.vel.y/stage_height,hp:s.hp,type:s.type,id:s.id}),s.s_pos.x=s.pos.x,s.s_pos.y=s.pos.y,s.s_vel.x=s.vel.x,s.s_vel.y=s.vel.y}}communication.socket.emit("force client sync",t)}},sendSyncDeadCharacter:function(t,e,a){if(gamemode==GameMode.MultiPlayer){var s={type:t,index:e,id:a};communication.socket.emit("sync dead character",s)}},sendSyncPath:function(){},upgrade_cost:function(t){var e;switch(t){case UpgradeType.Attack:e=this.attack_upgrades;break;case UpgradeType.Defense:e=this.defense_upgrades;break;case UpgradeType.Speed:e=this.speed_upgrades}return 5+5*e},upgrade:function(t){var e=this.upgrade_cost(t);return this.coins>=e?(this.coins-=e,!0):!1},upgrade_finished:function(t){switch(t){case UpgradeType.Attack:this.attack_upgrades++;break;case UpgradeType.Defense:this.defense_upgrades++;break;case UpgradeType.Speed:this.speed_upgrades++}for(var e=0;e<this.characters[CharacterType.Cow].length;e++){var a=this.characters[CharacterType.Cow][e];a.upgrade_update()}}};var getstartlocation=function(t){switch(loc=new PVector(0,0),t){case StartLocation.NW:loc.x=0,loc.y=0;break;case StartLocation.NE:loc.x=stage_width-width,loc.y=0;break;case StartLocation.SW:loc.x=0,loc.y=stage_height-height;break;case StartLocation.SE:loc.x=stage_width-width,loc.y=stage_height-height}return loc},getCoin=function(t,e){t==myteam&&particles.spawn({x:e.pos.x,y:e.pos.y,lifespan_d:10,ax:getRandomArbitrary(-1,1)*-width*.001,ay:getRandomArbitrary(.5,1)*-height*.001,rs:.025*dim,re:.025*dim,container:stage},ParticleType.COIN),gamemode==GameMode.SinglePlayer?game.teams[t].coins++:game.teams[t].sync_force=!0};